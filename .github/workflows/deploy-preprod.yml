name: Deployment front (PREPROD)

on:
    push:
        branches: [dev]

jobs:
    remove:
        runs-on: ubuntu-latest
        environment: preprod
        steps:
            - name: remove existing folder front
              uses: appleboy/ssh-action@master
              with:
                  host: ${{ secrets.REMOTE_HOST }}
                  username: ${{ secrets.REMOTE_USER }}
                  password: ${{ secrets.REMOTE_PASSWORD }}
                  port: ${{ secrets.REMOTE_PORT }}
                  script: '[ ! -e /srv/front/* ] || rm -r /srv/front/*'

    build:
        runs-on: ubuntu-latest
        environment: preprod
        needs: remove
        steps:
            - name: Download project from git
              uses: actions/checkout@v2

            - name: npm install
              run: npm i

            - name: Build project
              run: npm run build

    deploy:
        runs-on: ubuntu-latest
        environment: preprod
        needs: build

        steps:
            - name: Download project from git
              uses: actions/checkout@v2

            - name: Deploy project with SSH
              uses: easingthemes/ssh-deploy@v2.1.4
              env:
                  SSH_PRIVATE_KEY: ${{ secrets.REMOTE_SSH_KEY }}
                  REMOTE_HOST: ${{ secrets.REMOTE_HOST }}
                  REMOTE_USER: ${{ secrets.REMOTE_USER }}
                  SOURCE: './'
                  TARGET: '/srv/front'
    restart_pm2:
      runs-on: ubuntu-latest
      environment: preprod
      needs: deploy
      steps:
        - name: launch SSR server
          uses: appleboy/ssh-action@master
          with:
            host: ${{ secrets.REMOTE_HOST }}
            username: ${{ secrets.REMOTE_USER }}
            key: ${{ secrets.REMOTE_SSH_KEY }}
            port: ${{ secrets.REMOTE_PORT }}
            script: "pm2 restart front-next"
